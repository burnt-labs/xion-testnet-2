name: Create Release PR 

on:
  push:
    branches:
      # - main
      # - master
      - feat/do-85-generate-upgrade-proposals-n-release-binaries

  workflow_dispatch: # NOTICE: To trigger the workflow_dispatch event, the workflow must be in the default branch.
    inputs:
      release_tag:
        description: 'Release tag to update the chain registry with'
        required: true
        type: string
      deposit:
        description: 'Deposit amount (default: 1000000000uxion)'
        required: false
        default: '1000000000uxion'
        type: string
      expedited:
        description: 'Expedited proposal'
        required: false
        default: false
        type: boolean

env:
  # API endpoints
  XION_TESTNET_API: "https://api.xion-testnet-2.burnt.com/cosmos/base/tendermint/v1beta1"
  
  # Input values from workflow_dispatch
  # RELEASE_TAG: ${{ github.event.inputs.release_tag }}
  RELEASE_TAG: v22.0.0 # TODO : delete this
  # DEPOSIT: ${{ github.event.inputs.deposit }}
  DEPOSIT: 1000000000uxion # TODO : delete this
  # EXPEDITED: ${{ github.event.inputs.expedited }}
  EXPEDITED: false # TODO : delete this
  
  # Placeholder values for binary checksums
  PLACEHOLDER_CHECKSUM_DARWIN_AMD64: "--ADD-HERE-YOUR-VALUE--"
  PLACEHOLDER_CHECKSUM_DARWIN_ARM64: "--ADD-HERE-YOUR-VALUE--"
  PLACEHOLDER_CHECKSUM_LINUX_AMD64: "--ADD-HERE-YOUR-VALUE--"
  PLACEHOLDER_CHECKSUM_LINUX_ARM64: "--ADD-HERE-YOUR-VALUE--"

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
        
    - name: Calculate block height
      run: |
        # Get current block height and timestamp
        CURRENT_BLOCK=$(curl -s -X 'GET' "${{ env.XION_TESTNET_API }}/blocks/latest" -H 'accept: application/json' | jq -r '.block.header.height')
        CURRENT_TIME=$(curl -s -X 'GET' "${{ env.XION_TESTNET_API }}/blocks/latest" -H 'accept: application/json' | jq -r '.block.header.time')
        
        echo "Current block: $CURRENT_BLOCK"
        echo "Current time: $CURRENT_TIME"
        
        # Get block from 10000 blocks ago
        OLD_BLOCK=$((CURRENT_BLOCK - 10000))
        OLD_BLOCK_INFO=$(curl -s -X 'GET' "${{ env.XION_TESTNET_API }}/blocks/$OLD_BLOCK" -H 'accept: application/json' | jq -r '.block.header.time')
        
        echo "Old block ($OLD_BLOCK) time: $OLD_BLOCK_INFO"
        
        # Calculate average block time (in seconds)
        CURRENT_TIMESTAMP=$(date -d "$CURRENT_TIME" +%s)
        OLD_TIMESTAMP=$(date -d "$OLD_BLOCK_INFO" +%s)
        TIME_DIFF=$((CURRENT_TIMESTAMP - OLD_TIMESTAMP))
        AVERAGE_BLOCK_TIME=$(echo "scale=2; $TIME_DIFF / 10000" | bc)
        
        echo "Average block time: ${AVERAGE_BLOCK_TIME} seconds"
        
        # Calculate blocks for 2 days (172800 seconds)
        BLOCKS_IN_2_DAYS=$(echo "scale=0; 172800 / $AVERAGE_BLOCK_TIME" | bc)
        
        # Calculate target block height (round to nearest 1000)
        TARGET_BLOCKS=$((BLOCKS_IN_2_DAYS + CURRENT_BLOCK))
        ROUNDED_BLOCKS=$(( (TARGET_BLOCKS + 500) / 1000 * 1000 ))
        
        echo "Blocks in 2 days: $BLOCKS_IN_2_DAYS"
        echo "Target block height: $ROUNDED_BLOCKS"
        
        # Set the calculated height as environment variable
        echo "CALCULATED_HEIGHT=$ROUNDED_BLOCKS" >> $GITHUB_ENV

    - name: Fetch release checksums
      run: |
        # Construct the checksums URL for the release
        CHECKSUMS_URL="https://github.com/burnt-labs/xion/releases/download/${{ env.RELEASE_TAG }}/xiond-${{ env.RELEASE_TAG }}-checksums.txt"
        echo "Fetching checksums from: $CHECKSUMS_URL"
        
        # Try to fetch the checksums file
        CHECKSUMS_RESPONSE=$(curl -s -w "%{http_code}" "$CHECKSUMS_URL" -o checksums_temp.txt)
        HTTP_CODE="${CHECKSUMS_RESPONSE: -3}"
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Successfully fetched checksums for ${{ env.RELEASE_TAG }}"
          
          # Parse the checksums file and extract values
          CHECKS_FILE="checksums_temp.txt"
          
          # Extract checksums for different platforms
          DARWIN_AMD64_CHECKSUM=$(grep "darwin_amd64.tar.gz" "$CHECKS_FILE" | awk '{print $1}')
          DARWIN_ARM64_CHECKSUM=$(grep "darwin_arm64.tar.gz" "$CHECKS_FILE" | awk '{print $1}')
          LINUX_AMD64_CHECKSUM=$(grep "linux_amd64.tar.gz" "$CHECKS_FILE" | awk '{print $1}')
          LINUX_ARM64_CHECKSUM=$(grep "linux_arm64.tar.gz" "$CHECKS_FILE" | awk '{print $1}')
          
          # Set environment variables with real checksums
          echo "DARWIN_AMD64_CHECKSUM=$DARWIN_AMD64_CHECKSUM" >> $GITHUB_ENV
          echo "DARWIN_ARM64_CHECKSUM=$DARWIN_ARM64_CHECKSUM" >> $GITHUB_ENV
          echo "LINUX_AMD64_CHECKSUM=$LINUX_AMD64_CHECKSUM" >> $GITHUB_ENV
          echo "LINUX_ARM64_CHECKSUM=$LINUX_ARM64_CHECKSUM" >> $GITHUB_ENV
          
          echo "âœ… Using real checksums:"
          echo "  Darwin AMD64: $DARWIN_AMD64_CHECKSUM"
          echo "  Darwin ARM64: $DARWIN_ARM64_CHECKSUM"
          echo "  Linux AMD64: $LINUX_AMD64_CHECKSUM"
          echo "  Linux ARM64: $LINUX_ARM64_CHECKSUM"
          
        else
          echo "âš ï¸  Checksums file not found for ${{ env.RELEASE_TAG }} (HTTP $HTTP_CODE)"
          echo "ðŸ“ Using placeholder values"
          
          # Set environment variables with placeholder values
          echo "DARWIN_AMD64_CHECKSUM=${{ env.PLACEHOLDER_CHECKSUM_DARWIN_AMD64 }}" >> $GITHUB_ENV
          echo "DARWIN_ARM64_CHECKSUM=${{ env.PLACEHOLDER_CHECKSUM_DARWIN_ARM64 }}" >> $GITHUB_ENV
          echo "LINUX_AMD64_CHECKSUM=${{ env.PLACEHOLDER_CHECKSUM_LINUX_AMD64 }}" >> $GITHUB_ENV
          echo "LINUX_ARM64_CHECKSUM=${{ env.PLACEHOLDER_CHECKSUM_LINUX_ARM64 }}" >> $GITHUB_ENV
          
          echo "ðŸ“ Using placeholder checksums"
        fi
        
        # Clean up temporary file
        rm -f checksums_temp.txt
  
    - name: Get GitHub comparison data
      run: |
        # Extract version number from release tag
        CURRENT_VERSION="${{ env.RELEASE_TAG }}"
        # Extract major version number and calculate previous version
        CURRENT_MAJOR=$(echo "$CURRENT_VERSION" | sed 's/v\([0-9]*\)\.0\.0/\1/')
        PREVIOUS_MAJOR=$((CURRENT_MAJOR - 1))
        
        PREVIOUS_VERSION="v${PREVIOUS_MAJOR}.0.0"
        
        echo "Current version: $CURRENT_VERSION"
        echo "Previous version: $PREVIOUS_VERSION"
        
        # Get GitHub comparison data
        COMPARISON_URL="https://api.github.com/repos/burnt-labs/xion/compare/$PREVIOUS_VERSION...$CURRENT_VERSION"
        echo "Fetching comparison from: $COMPARISON_URL"
        
        # Fetch the comparison data
        COMPARISON_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$COMPARISON_URL")
        
        # Save comparison data to file for Claude API
        echo "$COMPARISON_DATA" > comparison_data.json
        
        # Extract key information
        COMMIT_COUNT=$(echo "$COMPARISON_DATA" | jq -r '.total_commits // 0')
        FILES_CHANGED=$(echo "$COMPARISON_DATA" | jq -r '.files | length // 0')
        
        echo "Commits: $COMMIT_COUNT"
        echo "Files changed: $FILES_CHANGED"
        
        # Set environment variables
        echo "PREVIOUS_VERSION=$PREVIOUS_VERSION" >> $GITHUB_ENV
        echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
        echo "FILES_CHANGED=$FILES_CHANGED" >> $GITHUB_ENV
        
#     - name: Generate release notes with Claude API
#       run: |
#         # Prepare the prompt for Claude API
#         PROMPT="You are a technical writer for the Xion blockchain project. Please analyze the GitHub comparison data and create a comprehensive release notes document for version ${{ env.RELEASE_TAG }}.
        
#         Format the release notes as a markdown document with the following structure:
        
#         # Xion ${{ env.RELEASE_TAG }} Release Notes
        
#         ## Overview
#         [Brief overview of the release]
        
#         ## What's Changed
#         ### ${{ env.RELEASE_TAG }} (Only Version)
        
#         #### Major Changes
#         [List major features/changes with PR links]
        
#         #### Bug Fixes & Improvements
#         [List bug fixes and improvements with PR links]
        
#         #### Testing & Code Quality
#         [List testing improvements and code quality changes]
        
#         ## Upgrade Information
#         - **Upgrade Height**: ${{ env.CALCULATED_HEIGHT }} (testnet)
#         - **Proposal Number**: [will be filled by script]
        
#         ## Release Links
#         - **${{ env.RELEASE_TAG }}**: [GitHub Release](https://github.com/burnt-labs/xion/releases/tag/${{ env.RELEASE_TAG }})
        
#         ## Contributors
#         [List contributors based on the commits]
        
#         ## Full Changelog
#         [${{ env.PREVIOUS_VERSION }}...${{ env.RELEASE_TAG }}](https://github.com/burnt-labs/xion/compare/${{ env.PREVIOUS_VERSION }}...${{ env.RELEASE_TAG }})
        
#         ---
        
#         For more information about the upgrade process, please refer to the [upgrade proposal](../proposals/[proposal-number]-upgrade-${{ env.RELEASE_TAG }}.json).
        
#         Analyze the comparison data and create professional, detailed release notes. Focus on user-facing changes, technical improvements, and security updates."
        
#         # Call Claude API
#         CLAUDE_RESPONSE=$(curl -s -X POST "https://api.anthropic.com/v1/messages" \
#           -H "Content-Type: application/json" \
#           -H "x-api-key: ${{ secrets.CLAUDE_API_KEY }}" \
#           -H "anthropic-version: 2023-06-01" \
#           -d '{
#             "model": "claude-3-sonnet-20240229",
#             "max_tokens": 4000,
#             "messages": [
#               {
#                 "role": "user",
#                 "content": "'"$PROMPT"'\n\nGitHub Comparison Data:\n'"$(cat comparison_data.json | jq -c .)"'"
#               }
#             ]
#           }')
        
#         # Extract the response content
#         RELEASE_NOTES_CONTENT=$(echo "$CLAUDE_RESPONSE" | jq -r '.content[0].text')
        
#         # Save the generated release notes
#         echo "$RELEASE_NOTES_CONTENT" > generated_release_notes.md
        
#         echo "Generated release notes saved to generated_release_notes.md"
         
#     - name: Run release files creation script
#       run: |
#         # Use the generated release notes if available, otherwise use template
#         if [ -f "generated_release_notes.md" ]; then
#           echo "Using AI-generated release notes"
#           cp generated_release_notes.md release_notes_template.md
#         else
#           echo "Using fallback template (Claude API may have failed)"
#           # Create a basic template as fallback
#           cat > release_notes_template.md << EOF
#         # Xion ${{ env.RELEASE_TAG }} Release Notes
        
#         ## Overview
#         Xion ${{ env.RELEASE_TAG }} includes various improvements and bug fixes.
        
#         ## What's Changed
#         ### ${{ env.RELEASE_TAG }} (Only Version)
        
#         #### Major Changes
#         - [Changes will be filled by AI generation]
        
#         ## Upgrade Information
#         - **Upgrade Height**: ${{ env.CALCULATED_HEIGHT }} (testnet)
#         - **Proposal Number**: [will be filled by script]
        
#         ## Release Links
#         - **${{ env.RELEASE_TAG }}**: [GitHub Release](https://github.com/burnt-labs/xion/releases/tag/${{ env.RELEASE_TAG }})
        
#         ## Full Changelog
#         [${{ env.PREVIOUS_VERSION }}...${{ env.RELEASE_TAG }}](https://github.com/burnt-labs/xion/compare/${{ env.PREVIOUS_VERSION }}...${{ env.RELEASE_TAG }})
#         EOF
#         fi
        
#         ./scripts/create-release-pr.sh "${{ env.RELEASE_TAG }}" "${{ env.CALCULATED_HEIGHT }}" "${{ env.DEPOSIT }}" "${{ env.EXPEDITED }}"
        
#     - name: Set environment variables from script output
#       run: |
#         # Extract information from the created files for later steps
#         LATEST_PROPOSAL=$(ls proposals/ | grep -E '^[0-9]{3}-upgrade-v[0-9]+\.json$' | sort -V | tail -1)
#         LATEST_RELEASE=$(ls releases/ | grep -E '^v[0-9]+\.json$' | sed 's/v\([0-9]*\)\.json/\1/' | sort -n | tail -1)
#         NEXT_VERSION_NUM=$((LATEST_RELEASE + 1))
#         VERSION="v${NEXT_VERSION_NUM}"
        
#         BRANCH_NAME="release/$VERSION.0.0"
        
#         echo "PROPOSAL_FILE=proposals/$LATEST_PROPOSAL" >> $GITHUB_ENV
#         echo "VERSION=$VERSION" >> $GITHUB_ENV
#         echo "RELEASE_FILE=releases/$VERSION.json" >> $GITHUB_ENV
#         echo "RELEASE_NOTES_FILE=release_notes/$VERSION.md" >> $GITHUB_ENV
#         echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        
#     - name: Create feature branch and commit changes
#       run: |
#         git config --local user.email "action@github.com"
#         git config --local user.name "GitHub Action"
        
#         # Create and switch to feature branch
#         git checkout -b "${{ env.BRANCH_NAME }}"
        
#         # Add all changes
#         git add .
        
#         if git diff --staged --quiet; then
#           echo "No changes to commit"
#           exit 1
#         else
#           git commit -m "Added release ${{ env.VERSION }}
          
#           - Created ${{ env.PROPOSAL_FILE }}
#           - Created ${{ env.RELEASE_FILE }}
#           - Created ${{ env.RELEASE_NOTES_FILE }}
          
#           Release Tag: ${{ env.RELEASE_TAG }}
#           Upgrade height: ${{ env.CALCULATED_HEIGHT }} (calculated: 2 days from current block)
#           Deposit: ${{ env.DEPOSIT }}
#           Expedited: ${{ env.EXPEDITED }}"
          
#           # Push the feature branch
          
#         fi
# #git push origin "${{ env.BRANCH_NAME }}"
        

    # - name: Create Pull Request
    #   uses: peter-evans/create-pull-request@v5
    #   with:
    #     token: ${{ secrets.GITHUB_TOKEN }}
    #     branch: ${{ env.BRANCH_NAME }}  # Source: release/vXX.0.0
    #     base: main                      # Target: main
    #     title: "Added release ${{ env.VERSION }}"
    #     body: |
    #       ## Upgrade to release ${{ env.VERSION }}
          
    #       This PR upgrades to release ${{ env.VERSION }}.
          
    #       ### Files created/modified:
    #       - `${{ env.PROPOSAL_FILE }}`
    #       - `${{ env.RELEASE_FILE }}`
    #       - `${{ env.RELEASE_NOTES_FILE }}`
          
    #       ### Configuration:
    #       - **Release Tag**: ${{ env.RELEASE_TAG }}
    #       - **Upgrade Height**: ${{ env.CALCULATED_HEIGHT }} (calculated: 2 days from current block)
    #       - **Deposit**: ${{ env.DEPOSIT }}
    #       - **Expedited**: ${{ env.EXPEDITED }}
          
    #       ### Next Steps:
    #       1. Update the checksums in `${{ env.RELEASE_FILE }}` with actual release binary checksums
    #       2. Fill in the release notes in `${{ env.RELEASE_NOTES_FILE }}` with actual changes and contributors
    #       3. Review the proposal details
    #       4. Submit the proposal on-chain when ready
    #     delete-branch: false
